<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üåå Sinapse Espacial ‚Äî Craft Infinito</title>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD0O1jfKbZnNbhxBgQ2zorXnvdY55tH8",
    authDomain: "level-up-academy-698fa.firebaseapp.com",
    projectId: "level-up-academy-698fa",
    storageBucket: "level-up-academy-698fa.appspot.com",
    messagingSenderId: "96904343253",
    appId: "1:96904343253:web:4f938c593c3968951b7c5c",
    measurementId: "G-MTNLINL7YPH"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Normaliza para o idioma do banco
  function toDbId(ids) {
    return ids.map(id => TRANSLATE[id] || id);
  }

  // Procura a receita no Firestore usando nomes em portugu√™s
  async function findRecipeDb(ids) {
    const idsPT = toDbId(ids); // converte p/ portugu√™s antes de consultar
    const idCanonical = [...idsPT].sort().join('+');
    const idAsIs = idsPT.join('+');
    // const idReverse = [...idsPT].reverse().join('+'); // üßπ REMOVER ESTA LINHA

    const tries = [...new Set([idCanonical, idAsIs])]; // idReverse removido

    for (const id of tries) {
      const ref = doc(db, "respostas", id);
      const snap = await getDoc(ref);
      if (snap.exists()) return snap.data();
    }
    return null;
  }

  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    /* ======= Pixel Retro Style ======= */
    @keyframes pixelGlow {
      0% { box-shadow: 0 0 5px #ff0000; }
      25% { box-shadow: 0 0 10px #00ff00; }
      50% { box-shadow: 0 0 15px #0000ff; }
      75% { box-shadow: 0 0 10px #ffff00; }
      100% { box-shadow: 0 0 5px #ff00ff; }
    }
    @keyframes pixelPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    @keyframes twinkle {
      0% { opacity: .25; transform: scale(.9); }
      100% { opacity: 1; transform: scale(1.1); }
    }
    .pixel-art { image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; }
    .glitch-effect { animation: pixelGlow .6s infinite; }
    .pulse-effect { animation: pixelPulse 1s infinite; }
    .retro-border { border: 4px solid #3b3b3b; box-shadow: inset 0 0 0 2px #fff, inset 0 0 0 6px #3b3b3b; }

    .star { position:absolute; background:#fff; border-radius:50%; animation: twinkle 2.2s infinite alternate; }
    .pixel-button { position:relative; overflow:hidden; }
    .pixel-button:active{ top:2px; }
    .pixel-button:after{
      content:''; position:absolute; left:0; top:0; width:100%; height:50%; background:rgba(255,255,255,.07);
    }

    /* Scrollbars sutis */
    *::-webkit-scrollbar { width: 10px; height: 10px; }
    *::-webkit-scrollbar-thumb { background: #4b5563; border:2px solid #111827; }
    *::-webkit-scrollbar-track { background: #111827; }

    /* Chips de elemento */
    .chip { cursor:pointer; }
    .chip:hover { filter: brightness(1.1); transform: translateY(-1px); }

    /* Estilo padr√£o de todos os itens */
    .item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 6px 6px;
      margin: 8px;
      border: 2px solid #ccc;
      border-radius: 12px;
      background: #111;
      color: white;
      font-size: 13px;
      text-align: center;
      min-width: 64px;
      min-height: 64px;
      max-width: 72px;
      max-height: 72px;
      box-sizing: border-box;
      gap: 2px;
    }

    .item .text-emoji {
      font-size: 2rem; /* Tamanho padr√£o para todos os emojis */
      margin-bottom: 2px;
    }

    .item .text-label {
      font-size: 12px;
      line-height: 1.1;
      font-weight: 500;
    }

    /* S√≥ os 4 iniciais (destaque fixo) */
    .item-base {
      border-width: 3px;
      font-weight: bold;
    }
  </style>
</head>

<body class="bg-black text-white font-mono min-h-screen overflow-x-hidden relative">
  <!-- Fundo estrelado -->
  <div id="stars" class="fixed inset-0 overflow-hidden z-0"></div>

  <div class="container mx-auto px-4 py-6 relative z-10">
    <!-- Header -->
    <header class="mb-6 text-center retro-border bg-gray-900 p-4">
      <h1 class="text-3xl md:text-5xl font-extrabold mb-2 text-yellow-400 pixel-art">üåå SINAPSE ESPACIAL</h1>
      <p class="text-base md:text-lg text-blue-300">Craft infinito em pixel art retr√¥ ‚Äî aprendizagem por mec√¢nicas</p>
      <div class="mt-2">
        <a href="LUA.html" class="inline-flex items-center gap-2 pixel-button bg-purple-700 hover:bg-purple-800 text-white px-3 py-1 md:px-4 md:py-2 font-bold retro-border text-sm md:text-base">
          <i class="fa-solid fa-angles-left"></i> Voltar para L.U.A.
        </a>
      </div>
    </header>
    <div class="flex flex-col lg:flex-row gap-6">

      <!-- Painel Esquerdo ‚Äî Invent√°rio + Sele√ß√£o -->
      <aside class="w-full lg:w-1/4 retro-border bg-gray-900 p-4 h-fit">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold mb-2 text-green-400">üì¶ Invent√°rio (Planeta)</h2>
          <button id="toggleInv" class="pixel-button bg-gray-800 hover:bg-gray-700 text-white px-3 py-1 font-bold retro-border text-xs">
            Global
          </button>
        </div>

        <div class="mb-2 text-xs text-gray-300">
          Filtros:
          <select id="filterSelect" class="bg-gray-800 retro-border py-1 px-2 text-xs">
            <option value="all">Todos</option>
            <option value="biol√≥gico">Biol√≥gicos</option>
            <option value="rocha">Rochas</option>
            <option value="l√≠quido">L√≠quidos</option>
            <option value="energia">Energia</option>
            <option value="tecnologia">Tecnologia</option>
            <option value="cultural">Cultural</option>
            <option value="constru√ß√£o">Constru√ß√£o</option>
            <option value="qu√≠mico">Qu√≠mico</option>
          </select>
        </div>

        <div id="inventory" class="grid grid-cols-4 gap-4"></div>

        <div class="mt-5">
          <h3 class="text-lg font-bold mb-2 text-purple-400">üîç Selecionados</h3>
          <div id="selected" class="flex flex-wrap gap-2 min-h-16 border-2 border-dashed border-gray-600 p-2">
            <p class="text-gray-500 text-sm">Clique nos itens do invent√°rio para selecionar</p>
          </div>

          <div class="mt-4 flex justify-between gap-2">
            <button id="combine" class="pixel-button bg-green-600 hover:bg-green-700 text-white px-4 py-2 font-bold retro-border">
              üî• Combinar
            </button>
            <button id="clearSel" class="pixel-button bg-red-600 hover:bg-red-700 text-white px-4 py-2 font-bold retro-border">
              üóëÔ∏è Limpar
            </button>
          </div>
        </div>
      </aside>

      <!-- Painel Central ‚Äî √Årea de Crafting -->
      <main class="w-full lg:w-2/4 retro-border bg-gray-900 p-4">
        <h2 class="text-xl font-bold mb-4 text-yellow-400">‚öôÔ∏è √Årea de Crafting</h2>

        <div id="result" class="bg-gray-800 p-6 text-center mb-6 min-h-32 flex flex-col justify-center items-center">
          <div id="resultIcon" class="w-16 h-16 mb-4"></div>
          <p id="resultText" class="text-lg">Selecione 2 a 6 itens e combine para descobrir!</p>
        </div>

        <div class="mb-6">
          <h3 class="text-lg font-bold mb-2 text-blue-400">üìú Hist√≥rico</h3>
          <div id="history" class="bg-gray-800 p-4 h-52 overflow-y-auto text-sm"></div>
        </div>

        <div class="bg-gray-800 p-4">
          <h3 class="text-lg font-bold mb-2 text-pink-400">üí° Dica</h3>
          <p id="hint" class="text-sm">Comece com Fogo + √Ågua, Terra + √Ågua, ou √Ågua + Vento.</p>
        </div>
      </main>

      <!-- Painel Direito ‚Äî Progresso, Planetas, Conquistas -->
      <aside class="w-full lg:w-1/4 retro-border bg-gray-900 p-4 h-fit">
        <h2 class="text-xl font-bold mb-4 text-red-400">üìä Progresso</h2>

        <div class="mb-5">
          <div class="flex justify-between mb-1">
            <span>XP: <span id="xp">0</span></span>
            <span id="level">N√≠vel 1</span>
          </div>
          <div class="w-full bg-gray-700 h-6 retro-border">
            <div id="xpBar" class="bg-blue-500 h-full w-0 transition-all duration-500"></div>
          </div>
          <div class="text-xs mt-1 text-gray-300">Para o pr√≥ximo n√≠vel: <span id="xpNext">100</span></div>
        </div>

        <div class="mb-5">
          <div class="flex justify-between mb-1">
            <span>Descobertas: <span id="discoveries">0</span></span>
            <span>Planeta Atual: <span id="currentPlanet">Terra Primordial</span></span>
          </div>
          <div class="w-full bg-gray-700 h-6 retro-border">
            <div id="planetBar" class="bg-green-500 h-full w-0 transition-all duration-500"></div>
          </div>
          <div class="text-xs mt-1 text-gray-300">Pr√≥ximo planeta: <span id="nextPlanet">Planeta 2</span></div>
        </div>

        <div class="mb-5">
          <h3 class="text-lg font-bold mb-2 text-purple-400 flex items-center gap-2">
            <span>üåü Descobertas</span>
            <span class="text-xs text-gray-400 ml-2">(Planeta: <span id="currentPlanetName"></span>)</span>
          </h3>
          <div class="flex items-center justify-center gap-2 text-2xl font-bold">
            <span id="planetDiscoveries">0</span>
            <span class="text-lg text-gray-400">/</span>
            <span id="planetTotal">0</span>
          </div>
          <div class="text-xs text-center text-gray-400 mt-1">
            Descobertas neste planeta
          </div>
        </div>

        <div class="mb-5">
          <h3 class="text-lg font-bold mb-2 text-green-400">ü™ê Planetas</h3>
          <div id="planets" class="grid grid-cols-2 gap-2"></div>
        </div>

        <div>
          <h3 class="text-lg font-bold mb-2 text-yellow-400">üèÜ Conquistas</h3>
          <div id="achievements" class="space-y-2"></div>
        </div>
      </aside>
    </div>

    <!-- Bot√£o Mapa Gal√°ctico -->
    <div class="fixed bottom-4 right-4">
      <button id="galaxyBtn" class="pixel-button bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 font-bold retro-border text-lg">
        <i class="fas fa-star"></i> Mapa Gal√°ctico
      </button>
    </div>
    <!-- Modal: Mapa Gal√°ctico -->
    <div id="galaxyModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex items-center justify-center p-4">
      <div class="bg-gray-900 retro-border p-6 max-w-5xl w-full max-h-screen overflow-auto">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl md:text-3xl font-bold text-purple-400">üåå Mapa Gal√°ctico</h2>
          <button id="closeGalaxy" class="pixel-button bg-red-600 hover:bg-red-700 text-white px-4 py-1 font-bold retro-border">X</button>
        </div>
        <div id="galaxyMap" class="w-full h-[500px] bg-gray-800 relative overflow-hidden">
          <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-yellow-400 rounded-full pulse-effect"></div>
        </div>
        <p class="mt-3 text-xs text-gray-400">Cada descoberta cria um n√≥ na sua gal√°xia mental. Clique nos n√≥s para ver o nome.</p>
      </div>
    </div>

    <!-- Bot√£o de Som -->
    <div class="fixed bottom-4 left-4 z-20">
      <button id="soundBtn" class="pixel-button bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full">
        <i class="fas fa-volume-up"></i>
      </button>
    </div>
    <!-- ======= SCRIPT DO JOGO ======= -->
    <script>
    // ---------- Util -----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    // ---------- Refer√™ncias DOM -----------
    const starsEl = $('#stars');
    const invEl = $('#inventory');
    const selectedEl = $('#selected');
    const resultEl = $('#result');
    const resultIcon = $('#resultIcon');
    const resultText = $('#resultText');
    const historyEl = $('#history');
    const hintEl = $('#hint');
    const xpEl = $('#xp'); const xpBar = $('#xpBar'); const xpNextEl = $('#xpNext'); const levelEl = $('#level');
    const discoveriesEl = $('#discoveries');
    const planetsEl = $('#planets');
    const achievementsEl = $('#achievements');
    const toggleInvBtn = $('#toggleInv');
    const filterSelect = $('#filterSelect');

    const combineBtn = $('#combine');
    const clearSelBtn = $('#clearSel');
    const galaxyBtn = $('#galaxyBtn');
    const galaxyModal = $('#galaxyModal'); const closeGalaxy = $('#closeGalaxy'); const galaxyMap = $('#galaxyMap');
    const soundBtn = $('#soundBtn');

    // ---------- Sons (placeholder via console) -----------
    const playSound = type => { if (!state.sound) return; console.log('sound:', type); };

    // ---------- Config de PlanetAS (reset e multiplicadores) -----------
    const PLANETS = [
      { id: 1, name: 'Terra Primordial', color: 'bg-blue-500', xpMult: 1, minComplex: 2 },
      { id: 2, name: 'BioG√™nese',        color: 'bg-green-500', xpMult: 1.2, minComplex: 2 },
      { id: 3, name: 'AquaMundi',        color: 'bg-cyan-500',  xpMult: 1.4, minComplex: 2 },
      { id: 4, name: 'GeoForja',         color: 'bg-amber-500', xpMult: 1.6, minComplex: 3 },
      { id: 5, name: 'TecnoP√≥lis',       color: 'bg-indigo-500',xpMult: 1.8, minComplex: 3 },
      { id: 6, name: 'Cultura Real',     color: 'bg-pink-500',  xpMult: 2.0, minComplex: 3 },
      { id: 7, name: 'Energia & F√≠sica', color: 'bg-red-500',   xpMult: 2.2, minComplex: 3 },
      { id: 8, name: 'Cosmos',           color: 'bg-purple-500',xpMult: 2.5, minComplex: 3 },
      { id: 9, name: 'Prototipia',       color: 'bg-teal-500',  xpMult: 3.0, minComplex: 4 },
      { id:10, name: 'Singularidade',    color: 'bg-yellow-500',xpMult: 3.5, minComplex: 4 },
    ];

    // ---------- Estado Global -----------
    const state = {
      sound: true,
      viewGlobal: false,
      planetIndex: 0, // come√ßa no Planeta 1 (index 0)
      level: 1,
      xp: 0,
      xpNext: 100,
      selected: [],
      history: [],
      // invent√°rios
      globalInv: new Set(['fire','water','earth','wind']),
      planetInv: [ // um por planeta
        new Set(['fire','water','earth','wind']),
        ...Array(9).fill(0).map(()=> new Set(['fire','water','earth','wind']))
      ],
      discovered: new Set(), // global
      achievements: new Set(),
      errorCount: 0, // contador de erros de combina√ß√£o
    };

    // ---------- Conquistas ----------
    const ACHIEVEMENTS = [
      { id:'first-discovery', name:'Primeira Descoberta', cond: s=>s.discovered.size>=1, icon:'üåü', desc:'Crie seu primeiro item.' },
      { id:'ten-discoveries', name:'Curioso', cond: s=>s.discovered.size>=10, icon:'üîé', desc:'10 descobertas √∫nicas.' },
      { id:'lv-5', name:'Aprendiz Gal√°ctico', cond: s=>s.level>=5, icon:'‚≠ê', desc:'Alcance n√≠vel 5.' },
      { id:'planet-3', name:'Explorador', cond: s=>s.planetIndex>=2, icon:'ü™ê', desc:'Chegue ao Planeta 3.' },
      { id:'craft-epic', name:'M√£o de Ouro', cond: s=>s.history.some(h=>h.tier==='√©pico'||h.tier==='lend√°rio'), icon:'üèÜ', desc:'Crie algo √©pico ou lend√°rio.' },
    ];

    // ---------- Cores por n√≠vel de item ----------
    const levelColor = lvl => {
      const colors = ['#FF5252','#FFD740','#69F0AE','#40C4FF','#B388FF','#FF4081'];
      return colors[Math.min(lvl-1, colors.length-1)];
    };

    // ---------- Util arrays/combina√ß√µes ----------
    const sortIds = arr => [...arr].sort();
    // function sameCombo(a,b) {
    //   if (a.length!==b.length) return false;
    //   const A = sortIds(a), B = sortIds(b);
    //   for (let i=0;i<A.length;i++){ if (A[i]!==B[i]) return false; }
    //   return true;
    // }

    // ---------- Estrelas de fundo ----------
    function buildStars(){
      const n=120;
      for(let i=0;i<n;i++){
        const s=document.createElement('div');
        s.className='star';
        const size = Math.random()*2+1;
        s.style.width=`${size}px`; s.style.height=`${size}px`;
        s.style.left=`${Math.random()*100}%`; s.style.top=`${Math.random()*100}%`;
        s.style.animationDelay=`${Math.random()*2}s`;
        starsEl.appendChild(s);
      }
    }
    // ---------- Banco base de elementos (nome, emoji, tags, planeta m√≠nimo sugerido) ----------
    // Observa√ß√£o: as receitas completas entram na PARTE 8.
    const ITEMS = {
      // base
      fire:{id:'fire',name:'Fogo',emoji:'üî•',tags:['energia'],lvl:1,planet:1},
      water:{id:'water',name:'√Ågua',emoji:'üíß',tags:['l√≠quido'],lvl:1,planet:1},
      earth:{id:'earth',name:'Terra',emoji:'üåç',tags:['rocha'],lvl:1,planet:1},
      wind:{id:'wind',name:'Vento',emoji:'üå¨Ô∏è',tags:['energia'],lvl:1,planet:1},
    };

    // ---------- UI: Planetas ----------
    function renderPlanets(){
      planetsEl.innerHTML='';
      PLANETS.forEach((p,idx)=>{
        const card=document.createElement('div');
        const unlocked = state.level >= (idx*2+1) || idx===0; // libera√ß√£o progressiva
        card.className=`${unlocked?'':'opacity-40'} bg-gray-800 p-2 text-center retro-border cursor-pointer`;
        card.innerHTML=`
          <div class="w-12 h-12 mx-auto mb-1 ${p.color} rounded-full"></div>
          <p class="text-[11px] leading-3">${p.name}</p>`;
        card.addEventListener('click',()=>{
          if(!unlocked) { notify('Planeta bloqueado. Suba de n√≠vel!'); playSound('error'); return; }
          if(state.planetIndex!==idx){
            state.planetIndex=idx;
            // reseta invent√°rio do planeta (mant√©m 4 b√°sicos)
            if(state.planetInv[idx].size===4){ /* j√° base */ }
            notify(`ü™ê Voc√™ viajou para ${p.name}!`);
            playSound('combine');
            renderAll();
          }
        });
        planetsEl.appendChild(card);
      });
    }

    // ---------- UI: Invent√°rios ----------
    function currentInv(){ return state.viewGlobal ? state.globalInv : state.planetInv[state.planetIndex]; }

    function renderInventory(){
      invEl.innerHTML='';
      const inv = currentInv();
      const filter = filterSelect.value;
      [...inv].forEach(id=>{
        const it = ITEMS[id] || {id, name:id, emoji:'', tags:[], lvl:1};
        if (filter!=='all' && !(it.tags||[]).includes(filter)) return;

        const node = document.createElement('div');
        node.className = 'item retro-border bg-gray-800 text-center transition-all';

        // se for um dos 4 b√°sicos ‚Üí aplicar destaque
        if (['fire','water','earth','wind'].includes(it.id)) {
          node.classList.add('item-base');
        }

        node.title = it.name;
        node.innerHTML = `
  <div class="text-emoji">${it.emoji || ''}</div>
  <div class="text-label">${it.name}</div>
`;
        node.addEventListener('click',()=>toggleSelect(it.id));
        invEl.appendChild(node);
      });
    }

    function renderSelected(){
      selectedEl.innerHTML='';
      if(state.selected.length===0){
        selectedEl.innerHTML='<p class="text-gray-500 text-sm">Clique nos itens do invent√°rio para selecionar</p>';
        return;
      }
      state.selected.forEach((id, idx)=>{
        const it = ITEMS[id]||{id, name:id, emoji:''};
        const chip=document.createElement('div');
        chip.className='retro-border bg-gray-800 p-2 text-center cursor-pointer';
        chip.innerHTML=`<div class="text-xl">${it.emoji}</div><div class="text-[10px]">${it.name}</div>`;
        chip.addEventListener('click',()=>{
          // Remove apenas a ocorr√™ncia clicada
          state.selected.splice(idx,1);
          renderSelected(); updateHint();
        });
        selectedEl.appendChild(chip);
      });
    }

    function renderHistory(){
      historyEl.innerHTML='';
      state.history.slice(0,40).forEach(h=>{
        const row=document.createElement('div');
        row.className='mb-2 pb-2 border-b border-gray-700';
        if(h.type==='discovery'){
          const it = ITEMS[h.id]||{name:h.id,emoji:''};
          row.innerHTML=`
            <div class="flex items-center gap-2">
              <div class="text-xl">${it.emoji}</div>
              <div>
                <div>[${h.time}] ${h.msg}</div>
                <div class="text-xs text-blue-400">+${h.xp} XP (${h.tier})</div>
              </div>
            </div>`;
        }else{
          row.innerHTML=`<div class="text-yellow-400">[${h.time}] ${h.msg}</div>`;
        }
        historyEl.appendChild(row);
      });
    }

    function renderProgress(){
      xpEl.textContent = state.xp;
      xpNextEl.textContent = state.xpNext;
      levelEl.textContent = `N√≠vel ${state.level}`;
      const pct = Math.min(100, Math.floor((state.xp/state.xpNext)*100));
      xpBar.style.width = pct+'%';

      // Nome do planeta atual
      const planeta = PLANETS[state.planetIndex];
      $("#currentPlanetName").textContent = planeta.name;

      // Descobertas do planeta atual
      // Filtra os itens descobertos que pertencem ao planeta atual
      const descobertasPlaneta = [...state.discovered].filter(id => (ITEMS[id]?.planet || 1) === planeta.id);
      // Conta o total de itens poss√≠veis do planeta atual
      const totalPlaneta = Object.values(ITEMS).filter(it => it.planet === planeta.id).length;

      $("#planetDiscoveries").textContent = descobertasPlaneta.length;
      $("#planetTotal").textContent = totalPlaneta;

      discoveriesEl.textContent = state.discovered.size; // total global (se quiser manter)
    }

    function renderAchievements(){
      achievementsEl.innerHTML='';
      ACHIEVEMENTS.forEach(a=>{
        const unlocked = state.achievements.has(a.id);
        const row=document.createElement('div');
        row.className=`bg-gray-800 p-2 text-sm retro-border ${unlocked?'':'opacity-50'}`;
        row.innerHTML=`<span class="mr-2">${a.icon}</span> ${a.name} <span class="text-xs text-gray-400">‚Äî ${a.desc}</span>`;
        achievementsEl.appendChild(row);
      });
    }

    function renderAll(){ renderPlanets(); renderInventory(); renderSelected(); renderHistory(); renderProgress(); renderAchievements(); updateHint(); buildGalaxy(); }
    // ---------- Sele√ß√£o ----------
    function toggleSelect(id){
      // Permite m√∫ltiplas sele√ß√µes do mesmo item
      state.selected.push(id);
      playSound('select');
      renderSelected(); updateHint();
    }

    // ---------- Dica din√¢mica ----------
    function updateHint(){
      if(state.selected.length===0){ hintEl.textContent='Dica: Fogo + √Ågua = Vapor, Terra + √Ågua = Lama, √Ågua + Vento = Tempestade.'; return; }
      const names = state.selected.map(id => (ITEMS[id]?.name||id).toLowerCase());
      hintEl.textContent = `Tentando: ${names.join(' + ')}. Combine 2‚Äì6 itens.`;
    }

    // ---------- Notifica√ß√£o interna ----------
    function notify(msg){
      const now = new Date().toLocaleTimeString();
      state.history.unshift({type:'msg', time: now, msg});
      renderHistory();
    }

    // ---------- XP e Level ----------
    function addXP(base, tier='comum'){
      // tier multipliers
      const mult = {comum:1, incomum:1.5, raro:2.5, √©pico:5, lend√°rio:10}[tier]||1;
      const planetMult = PLANETS[state.planetIndex].xpMult;
      const total = Math.floor(base*mult*planetMult);
      state.xp += total;
      // level up
      while(state.xp >= state.xpNext){
        state.xp -= state.xpNext;
        state.level++;
        state.xpNext = Math.floor(state.xpNext * 1.5);
        notify(`‚≠ê N√≠vel ${state.level} alcan√ßado!`);
        playSound('levelup');
      }
      renderProgress();
      return total;
    }

    // ---------- Checar conquistas ----------
    function checkAchievements(){
      ACHIEVEMENTS.forEach(a=>{
        if(!state.achievements.has(a.id) && a.cond(state)){
          state.achievements.add(a.id);
          notify(`üèÜ Conquista desbloqueada: ${a.name}!`);
          playSound('discovery');
          renderAchievements();
        }
      });
    }

    // ---------- Combinar ----------
    async function combine(){
      if(state.selected.length<2){ setResult(null,'Selecione pelo menos 2 itens.'); playSound('error'); return; }

      const sel = sortIds(state.selected);
      const found = await findRecipe(sel);
      if(!found){
        setResult(null,'Combina√ß√£o inv√°lida!');
        resultEl.classList.add('glitch-effect');
        setTimeout(()=>resultEl.classList.remove('glitch-effect'),800);
        playSound('error');
        state.selected = [];
        renderSelected(); updateHint();

        // Incrementa contador de erro
        state.errorCount = (state.errorCount || 0) + 1;

        // Se chegou a 5 erros, mostra dica sutil
        if(state.errorCount >= 5){
          await showSubtleHint(); // <-- use await aqui!
          state.errorCount = 0; // reseta para n√£o repetir sempre
        }
        return;
      }

      // Se acertou, zera o contador de erros
      state.errorCount = 0;

      const {output, tier, xpBase, level} = found;

      // Verifica se j√° foi descoberto globalmente
      if (state.globalInv.has(output)) {
        setResult(output, "Esse elemento j√° foi criado");
        playSound('error');
        return;
      }

      // Se n√£o existir no ITEMS, cria usando os dados do Firestore (se existirem)
      if (!ITEMS[output]) {
        ITEMS[output] = {
          id: output,
          name: found.nome || output,
          emoji: found.emoji || '',
          lvl: level || 1,
          tags: found.tags || [],
          planet: found.planet || 1
        };
      }

      const it = ITEMS[output];

      const inv = currentInv();
      const wasNewGlobal = !state.globalInv.has(output);

      state.globalInv.add(output);
      inv.add(output);
      state.discovered.add(output);

      const gained = addXP(xpBase, tier);
      const now = new Date().toLocaleTimeString();
      state.history.unshift({type:'discovery', time:now, id:output, msg:`Voc√™ criou ${it.name}!`, xp:gained, tier});
      setResult(output, `Voc√™ criou ${it.name}! +${gained} XP`);
      playSound(wasNewGlobal?'discovery':'combine');
      buildGalaxy();
      checkAchievements();

      state.selected = [];
      renderInventory(); renderSelected(); renderProgress(); renderHistory();
      updateHint();
    }

    function setResult(id, msg){
      resultText.textContent = msg;
      if(id){
        const it = ITEMS[id] || {emoji:'‚ùî'};
        resultIcon.innerHTML = `<div class="text-5xl" title="${it.name}">${it.emoji}</div>`;
        resultEl.classList.add('pulse-effect');
        setTimeout(()=>resultEl.classList.remove('pulse-effect'),900);
      }else{
        resultIcon.innerHTML = '';
      }
    }

    // Fun√ß√£o para mostrar dica sutil baseada no invent√°rio
    async function showSubtleHint(){
      const inv = [...currentInv()];
      const dicas = [];

      // Gera todas as combina√ß√µes de 2 e 3 itens (com repeti√ß√£o)
      function* combos(arr, n) {
        const len = arr.length;
        if (n === 2) {
          for (let i = 0; i < len; i++)
            for (let j = 0; j < len; j++)
              yield [arr[i], arr[j]];
        } else if (n === 3) {
          for (let i = 0; i < len; i++)
            for (let j = 0; j < len; j++)
              for (let k = 0; k < len; k++)
                yield [arr[i], arr[j], arr[k]];
        }
      }

      // Testa combina√ß√µes de 2 e 3 itens (com repeti√ß√£o)
      for (const combo of combos(inv, 2)) {
        const found = await findRecipe(combo);
        if (found && !state.globalInv.has(found.output)) {
          dicas.push(`"${ITEMS[combo[0]].name}" + "${ITEMS[combo[1]].name}"`);
          if (dicas.length >= 3) break;
        }
      }
      if (dicas.length < 3) {
        for (const combo of combos(inv, 3)) {
          const found = await findRecipe(combo);
          if (found && !state.globalInv.has(found.output)) {
            dicas.push(`"${ITEMS[combo[0]].name}" + "${ITEMS[combo[1]].name}" + "${ITEMS[combo[2]].name}"`);
            if (dicas.length >= 3) break;
          }
        }
      }

      if (dicas.length > 0){
        hintEl.textContent = "Dica: Tente combinar: " + dicas.join(" ou ");
      } else {
        hintEl.textContent = "Voc√™ j√° descobriu tudo que pode com os itens atuais! Tente avan√ßar para outro planeta ou desbloquear mais itens.";
      }
    }

    // ---------- Eventos ----------
    combineBtn.addEventListener('click', combine);
    clearSelBtn.addEventListener('click', ()=>{ state.selected=[]; renderSelected(); updateHint(); playSound('clear'); });
    toggleInvBtn.addEventListener('click', ()=>{
      state.viewGlobal = !state.viewGlobal;
      toggleInvBtn.textContent = state.viewGlobal ? 'Planeta' : 'Global';
      renderInventory();
    });
    filterSelect.addEventListener('change', renderInventory);
    galaxyBtn.addEventListener('click', ()=> galaxyModal.classList.remove('hidden'));
    closeGalaxy.addEventListener('click', ()=> galaxyModal.classList.add('hidden'));
    soundBtn.addEventListener('click', ()=>{
      state.sound = !state.sound;
      soundBtn.innerHTML = state.sound ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
      soundBtn.className = state.sound ? 'pixel-button bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full' : 'pixel-button bg-gray-600 hover:bg-gray-700 text-white p-3 rounded-full';
    });
    // ---------- Mapa Gal√°ctico ----------
    function buildGalaxy(){
      galaxyMap.innerHTML='';
      const center=document.createElement('div');
      center.className='absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-yellow-400 rounded-full pulse-effect';
      galaxyMap.appendChild(center);

      const list=[...state.discovered];
      list.forEach((id,idx)=>{
        const it=ITEMS[id]||{name:id, emoji:'‚ùî', lvl:1};
        const angle = (idx / Math.max(1,list.length)) * Math.PI*2;
        const dist = 100 + idx*6;
        const x = 50 + Math.cos(angle)*dist/2;
        const y = 50 + Math.sin(angle)*dist/2;

        const node=document.createElement('div');
        node.className='absolute w-6 h-6 rounded-full flex items-center justify-center cursor-pointer';
        node.style.left = `${x}%`; node.style.top = `${y}%`;
        node.style.background = levelColor(it.lvl||1);
        node.innerHTML = `<span class="text-[12px]">${it.emoji}</span>`;
        node.title = it.name;

        // linhas
        const line=document.createElement('div');
        line.className='absolute bg-gray-600';
        line.style.left='50%'; line.style.top='50%';
        line.style.width= `${dist/2}%`; line.style.height='1px';
        line.style.transformOrigin='0 0';
        line.style.transform = `rotate(${angle}rad)`;

        galaxyMap.appendChild(line);
        galaxyMap.appendChild(node);
      });
    }

    // ---------- Inicializa√ß√£o ----------
    function init(){
      buildStars();
      renderAll();
      notify('Bem-vindo ao Sinapse Espacial! Crie, explore e aprenda.');
    }

    document.addEventListener('DOMContentLoaded', init);
    // ---------- RECEITAS (planet-to-planet) ----------
    // Cada entrada: { out:'id', name:'Nome', emoji:'', tags:[], lvl:n, planet:n, tier:'comum|incomum|raro|√©pico|lend√°rio', xp:base, recipe:[ids...] }
    // IMPORTANTe: receitas s√£o ORDEM-INSENSITIVA e aceitam duplicados (ex.: ['water','water']).

    const RECIPES = [
    ];

    // ---------- Registrar receitas no ITEMS ----------
    RECIPES.forEach(rc=>{
      if(!ITEMS[rc.out]) ITEMS[rc.out] = { id:rc.out, name:rc.name, emoji:rc.emoji, tags:rc.tags||[], lvl:rc.lvl||1, planet:rc.planet||1 };
    });

    // ---------- Localizador de receita ----------
    // Vers√£o ass√≠ncrona usando Firestore
    async function findRecipe(selectedIds){
      // pergunta ao Firestore
      const data = await window._fs.findRecipeDb(selectedIds);
      if (!data) return null;
      return {
        output: data.resultado,             // id do item de sa√≠da
        tier:   data.tier || 'comum',
        xpBase: data.xp   || 10,
        level:  data.lvl  || 1
      };
    }
    </script>
  </div> <!-- container -->

</body>
</html>
